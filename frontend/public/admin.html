<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
</head>
<body>
<h2>Admin Dashboard</h2>

<input type="email" id="email" placeholder="Admin Email" />
<input type="password" id="password" placeholder="Password" />
<button onclick="login()">Login</button>

<hr>

<input type="text" id="search" placeholder="Search user..." onkeyup="filterUsers()" />
<button onclick="loadUsers()">Load Users</button>

<table>
  <thead>
    <tr>
      <th>Email</th>
      <th>Role</th>
      <th>Plan</th>
      <th>Premium</th>
      <th>Expiry</th>
      <th>Change</th>
    </tr>
  </thead>
  <tbody id="usersBody"></tbody>
</table>

<script>
const API = "https://tipstorm-web-app-1.onrender.com";
let allUsers = [];

function getToken() {
  return localStorage.getItem("token");
}

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const res = await fetch(`${API}/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password })
  });

  const data = await res.json();
  if (!data.success || data.user.role !== "admin") {
    alert("Admin login failed");
    return;
  }

  localStorage.setItem("token", data.token);
  alert("Logged in");
}

async function loadUsers() {
  const token = getToken();
  if (!token) return alert("Login first");

  const res = await fetch(`${API}/all-users`, {
    headers: { "Authorization": `Bearer ${token}` }
  });

  const data = await res.json();
  if (!data.success) return alert(data.message);

  allUsers = data.users;
  renderUsers(allUsers);
}

function renderUsers(users) {
  const tbody = document.getElementById("usersBody");
  tbody.innerHTML = "";

  users.forEach(user => {
    const plan = user.plan || "free";
    const expiry = user.expiresAt
      ? new Date(user.expiresAt).toLocaleDateString()
      : "-";

    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${user.email}</td>
      <td>${user.role}</td>
      <td>${plan}</td>
      <td>${user.premium ? "YES" : "NO"}</td>
      <td>${expiry}</td>
      <td>
        <select id="plan-${user.email}">
          <option value="free">free</option>
          <option value="weekly">weekly</option>
          <option value="monthly">monthly</option>
          <option value="vip">vip</option>
        </select>
        <button onclick="activate('${user.email}')">Update</button>
      </td>
    `;

    tbody.appendChild(row);
  });
}

function filterUsers() {
  const search = document.getElementById("search").value.toLowerCase();
  const filtered = allUsers.filter(u =>
    u.email.toLowerCase().includes(search)
  );
  renderUsers(filtered);
}

async function activate(email) {
  const token = getToken();
  const plan = document.getElementById(`plan-${email}`).value;

  const res = await fetch(`${API}/activate`, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ userEmail: email, plan })
  });

  const data = await res.json();
  alert(data.message);
  loadUsers();
}
</script>
</body>
</html> 
