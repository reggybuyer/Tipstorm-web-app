<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>TipStorm Admin Dashboard</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #f4f4f4;
    }
    h2 { color: #222; }
    input, button, select {
      padding: 6px;
      margin: 5px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #222;
      color: white;
    }
    .section {
      margin-top: 25px;
      background: white;
      padding: 15px;
    }
  </style>
</head>
<body>

<h2>TipStorm Admin Dashboard</h2>

<label>Admin Email</label>
<input type="email" id="adminEmail" placeholder="admin email">

<label>Password</label>
<input type="password" id="adminPassword" placeholder="password">

<button onclick="adminLogin()">Login</button>

<hr>

<!-- USERS -->
<div class="section">
  <h3>Users</h3>
  <button onclick="loadUsers()">Load Users</button>

  <table id="usersTable">
    <thead>
      <tr>
        <th>Email</th>
        <th>Plan</th>
        <th>Premium</th>
        <th>Approved</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- CREATE SLIP -->
<div class="section">
  <h3>Create Slip</h3>

  <label>Date</label>
  <input type="date" id="slipDate">

  <label>Access</label>
  <select id="access">
    <option value="free">Free</option>
    <option value="weekly">Weekly</option>
    <option value="monthly">Monthly</option>
    <option value="vip">VIP</option>
  </select>

  <h4>Games</h4>
  <div id="gamesContainer"></div>

  <button onclick="addGame()">Add Game</button>
  <button onclick="createSlip()">Create Slip</button>
</div>

<!-- RESULTS -->
<div class="section">
  <h3>Slip Results</h3>

  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Game</th>
        <th>Odd</th>
        <th>Over/Under</th>
        <th>Result</th>
        <th>Update</th>
      </tr>
    </thead>
    <tbody id="slipBody"></tbody>
  </table>
</div>

<!-- PAYMENT INFO -->
<div class="section">
  <h3>Activation</h3>
  <p>Pay to Till: <strong>0789906001</strong></p>
  <p>Send:</p>
  <ul>
    <li>email</li>
    <li>plan</li>
    <li>payment confirmation</li>
    <li>message</li>
  </ul>
  <p>Send to WhatsApp/SMS: <strong>0789906001</strong></p>
</div>

<script>
const API = "https://tipstorm-web-app-1.onrender.com";

// ===== LOGIN =====
async function adminLogin() {
  const email = document.getElementById("adminEmail").value;
  const password = document.getElementById("adminPassword").value;

  const res = await fetch(`${API}/login`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ email, password })
  });

  const data = await res.json();
  if (!data.success || data.user.role !== "admin") {
    alert("Admin login failed");
    return;
  }

  localStorage.setItem("token", data.token);
  alert("Admin logged in");
}

// ===== USERS =====
async function loadUsers() {
  const token = localStorage.getItem("token");
  if (!token) return alert("Login first");

  const res = await fetch(`${API}/all-users`, {
    headers: {"Authorization": `Bearer ${token}`}
  });

  const data = await res.json();
  if (!data.success) {
    alert(data.message);
    return;
  }

  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";

  data.users.forEach(u => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${u.email}</td>
      <td>${u.plan}</td>
      <td>${u.premium}</td>
      <td>${u.approved}</td>
      <td>
        ${!u.approved ? `<button onclick="approveUser('${u.email}')">Approve</button>` : ""}
        <button onclick="activateUser('${u.email}')">Activate</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ===== APPROVE =====
async function approveUser(email) {
  const token = localStorage.getItem("token");

  const res = await fetch(`${API}/approve-user`, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ userEmail: email })
  });

  const data = await res.json();
  alert(data.message);
  loadUsers();
}

// ===== ACTIVATE =====
async function activateUser(email) {
  const token = localStorage.getItem("token");

  const res = await fetch(`${API}/activate`, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ userEmail: email, plan: "free" })
  });

  const data = await res.json();
  alert(data.message);
  loadUsers();
}

// ===== SLIPS =====
let games = [];

function addGame() {
  const container = document.getElementById("gamesContainer");

  const index = games.length;
  games.push({});

  const div = document.createElement("div");
  div.innerHTML = `
    <label>Home</label>
    <input id="home-${index}" type="text">

    <label>Away</label>
    <input id="away-${index}" type="text">

    <label>Odd</label>
    <input id="odd-${index}" type="number" step="0.01">

    <label>Over/Under</label>
    <input id="ou-${index}" type="text">

    <hr>
  `;
  container.appendChild(div);
}

async function createSlip() {
  const date = document.getElementById("slipDate").value;
  const access = document.getElementById("access").value;

  const builtGames = [];
  let totalOdds = 1;

  games.forEach((_, i) => {
    const home = document.getElementById(`home-${i}`).value;
    const away = document.getElementById(`away-${i}`).value;
    const odd = parseFloat(document.getElementById(`odd-${i}`).value);
    const ou = document.getElementById(`ou-${i}`).value;

    if (home && away && odd) {
      builtGames.push({ home, away, odd, overUnder: ou, result: "pending" });
      totalOdds *= odd;
    }
  });

  await fetch(`${API}/slips`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ date, games: builtGames, access, totalOdds })
  });

  alert(`Slip created. Total odds: ${totalOdds.toFixed(2)}`);
}

// ===== RESULTS =====
async function loadSlips() {
  const res = await fetch(`${API}/slips?plan=vip`);
  const data = await res.json();

  const tbody = document.getElementById("slipBody");
  tbody.innerHTML = "";

  data.slips.forEach(slip => {
    slip.games.forEach((g, index) => {
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${slip.date}</td>
        <td>${g.home} vs ${g.away}</td>
        <td>${g.odd}</td>
        <td>${g.overUnder}</td>
        <td>${resultBadge(g.result)}</td>
        <td>
          <button onclick="updateResult('${slip._id}', ${index}, 'win')">Win</button>
          <button onclick="updateResult('${slip._id}', ${index}, 'lost')">Lost</button>
          <button onclick="updateResult('${slip._id}', ${index}, 'pending')">Pending</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  });
}

function resultBadge(result) {
  if (result === "win") return "ðŸŸ¢ WIN";
  if (result === "lost") return "ðŸ”´ LOST";
  return "âšª PENDING";
}

async function updateResult(slipId, index, result) {
  await fetch(`${API}/slip-result`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ slipId, gameIndex: index, result })
  });

  alert("Result updated");
  loadSlips();
}

loadSlips();
</script>

</body>
</html> 
