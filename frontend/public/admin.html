<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TipStorm Admin Dashboard</title>
<link rel="stylesheet" href="/index.css">
<style>
  body { font-family: Arial; padding: 20px; background: #f4f4f4; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; }
  .card { background: white; padding: 12px; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<h2>TipStorm Admin Dashboard</h2>
<button onclick="logout()">Logout</button>

<label>Admin Email</label>
<input type="email" id="adminEmail">
<label>Password</label>
<input type="password" id="adminPassword">
<button onclick="adminLogin()">Login</button>

<hr>

<button onclick="loadUsers()">Load Users</button>
<div id="usersGrid" class="grid"></div>

<hr>

<h3>Create Slip</h3>
<label>Date</label>
<input type="date" id="slipDate">

<label>Access</label>
<select id="access">
  <option value="free">Free</option>
  <option value="weekly">Weekly</option>
  <option value="monthly">Monthly</option>
  <option value="vip">VIP</option>
</select>

<div id="gamesContainer"></div>
<button onclick="addGame()">Add Game</button>
<button onclick="createSlip()">Create Slip</button>

<hr>

<h3>Slip Results</h3>
<div id="slipGrid" class="grid"></div>

<script>
const API = "https://tipstorm-web-app-1.onrender.com";

function logout() {
  localStorage.removeItem("token");
  alert("Logged out");
}

async function adminLogin() {
  const email = document.getElementById("adminEmail").value;
  const password = document.getElementById("adminPassword").value;

  const res = await fetch(`${API}/login`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ email, password })
  });

  const data = await res.json();
  if (!data.success || data.user.role !== "admin") {
    alert("Admin login failed");
    return;
  }

  localStorage.setItem("token", data.token);
  alert("Admin logged in");
}

async function loadUsers() {
  const token = localStorage.getItem("token");
  if (!token) return alert("Login first");

  const res = await fetch(`${API}/all-users`, {
    headers: {"Authorization": `Bearer ${token}`}
  });

  const data = await res.json();
  const grid = document.getElementById("usersGrid");
  grid.innerHTML = "";

  data.users.forEach(u => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <strong>${u.email}</strong><br>
      Plan: ${u.plan}<br>
      Premium: ${u.premium}<br>
      Approved: ${u.approved}<br>
      <button onclick="approveUser('${u.email}')">Approve</button>
    `;
    grid.appendChild(div);
  });
}

async function approveUser(email) {
  const token = localStorage.getItem("token");
  await fetch(`${API}/approve-user`, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ userEmail: email })
  });
  alert("User approved");
  loadUsers();
}

let games = [];

function addGame() {
  const container = document.getElementById("gamesContainer");
  const index = games.length;
  games.push({});

  const div = document.createElement("div");
  div.innerHTML = `
    <input id="home-${index}" placeholder="Home">
    <input id="away-${index}" placeholder="Away">
    <input id="odd-${index}" type="number" step="0.01" placeholder="Odd">
    <input id="ou-${index}" placeholder="Over/Under">
    <hr>
  `;
  container.appendChild(div);
}

async function createSlip() {
  const date = document.getElementById("slipDate").value;
  const access = document.getElementById("access").value;
  let builtGames = [];
  let totalOdds = 1;

  games.forEach((_, i) => {
    const home = document.getElementById(`home-${i}`).value;
    const away = document.getElementById(`away-${i}`).value;
    const odd = parseFloat(document.getElementById(`odd-${i}`).value);
    const ou = document.getElementById(`ou-${i}`).value;

    if (home && away && odd) {
      builtGames.push({ home, away, odd, overUnder: ou, result: "pending" });
      totalOdds *= odd;
    }
  });

  if (totalOdds < 2) {
    alert("Minimum total odds must be 2 or more");
    return;
  }

  await fetch(`${API}/slips`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ date, games: builtGames, access, totalOdds })
  });

  alert("Slip created (Total odds: " + totalOdds.toFixed(2) + ")");
} 

async function loadSlips() {
  const res = await fetch(`${API}/slips?plan=vip`);
  const data = await res.json();
  const grid = document.getElementById("slipGrid");
  grid.innerHTML = "";

  data.slips.forEach(slip => {
    const div = document.createElement("div");
    div.className = "card";

    const badge = slip.access === "free"
      ? `<span class="badge free">FREE</span>`
      : `<span class="badge vip">PREMIUM</span>`;

    div.innerHTML = `
      <strong>${slip.date}</strong> ${badge}<br>
      Total Odds: ${slip.totalOdds.toFixed(2)}<br>
      Games: ${slip.games.length}
    `;

    grid.appendChild(div);
  });
}

loadSlips();
</script>
</body>
</html> 
